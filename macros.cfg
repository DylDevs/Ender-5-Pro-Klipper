# G-code macro to run on print start
# Heats up bed and extruder, levels bed, preps for purge line
[gcode_macro START_PRINT]
gcode:
    {% set BED_TEMP = params.BED_TEMP|default(60)|float %} # Define heated bed temperature
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(208)|float %} # Define extruder temperature
    M140 S{BED_TEMP} # Heat bed to BED_TEMP
    M190 S{BED_TEMP} # Wait for bed to reach BED_TEMP
    M109 S{EXTRUDER_TEMP} # Set extruder temp to EXTRUDER_TEMP and wait
    G28 # Home the printer
    BED_MESH_CALIBRATE # Level bed with CR Touch module
    G90 # Use absolute positioning
    G1 Z5 F3000 # Move the bed to 5mm absolute at 50mm/s
    G1 Z0.15 F300 # Move the bed to 0.15mm absolute at 5mm/s
    SETUP_LINE_PURGE # Initialize variables for purge line
    LINE_PURGE # Purge filament in a line near the object
    # Start print

# G-Code macro to run on print end
# Safely retracts filament, lowers bed, and disables heaters/steppers
[gcode_macro END_PRINT]
gcode:
    G91 # Use relative positioning
    G1 E-2 F2700 # Retract 2mm of filament at 45mm/s
    G1 E-2 Z0.2 F2400 # Retract 2mm of filament and raise the bed 0.2mm at 40mm/s
    G1 X5 Y5 F3000 # Move extruder diagonaly by 5mm at 50mm/s
    G1 Z10 # Lower bed by 10mm at 50mm/s (last used)
    G90 # Use absolute positioning
    G28 X0 Y0 # Move X and Y back home for a clear bed view
    M106 S0 # Turn off fan
    M104 S0 # Turn off hotend heater
    M140 S0 # Turn off bed heater
    M84 X Y E # Disable toolhead movement

[pause_resume] # Allow pausing and resuming of prints

# G-Code macro for changing filaments
# Pauses the print, moves extruder/bed, and retracts 50mm of filament
[gcode_macro M600]
gcode:
    {% set X = params.X|default(50)|float %} # Define extruder X position for filament change
    {% set Y = params.Y|default(0)|float %} # Define extruder Y position for filament change
    {% set Z = params.Z|default(10)|float %} # Define bed position for filament change
    SAVE_GCODE_STATE NAME=M600_state # Save G-Code state before pausing
    PAUSE # Pause the print
    G91 # Use relative positioning
    G1 E-.8 F2700 # Retracts filament by 0.8mm at 45mm/s
    G1 Z{Z} # Move bed down from current position by set value
    G90 # Use absolute positioning
    G1 X{X} Y{Y} F3000 # Move the extruder to its filament changing position
    G91 # Use relative positioning
    G1 E-50 F1000 # Retract 50mm of filament at ~17mm/s
    RESTORE_GCODE_STATE NAME=M600_state # Restore saved G-Code state

# G-Code macro to play a beep tone
# Play a ton at the set frequency for the set duration
[gcode_macro M300]
gcode:
    {% set S = params.S|default(1000)|int %} # Define the frequency of the tone
    {% set P = params.P|default(100)|int %} # Define the duration of the tone
    {% set L = 0.5 %} # L varies the PWM on time, close to 0 or 1 the tone gets a bit quieter. 0.5 is a symmetric waveform
    {% if S <= 0 %} # If the frequency is zero or negative
        {% set F = 1 %}  # Set a period of 1 second
        {% set L = 0 %}  # Zero duty cycle = silence
    {% elif S >= 10000 %} # If frequency is 10khz or above
        {% set F = 0 %}  # Disable PWM
    {% else %} # Valid frequency and duration
        {% set F = 1/S %}  # Calculate the PWM cycle time as the inverse of frequency
    {% endif %}
    SET_PIN PIN=BEEPER_Pin VALUE={L} CYCLE_TIME={F} # Play the tone
    G4 P{P} # Wait for the duration of the beep
    SET_PIN PIN=BEEPER_Pin VALUE=0 # Stop the tone

# Enable object exclusion
# If a multi object print fails, the object can be excluded to let the others continue
[exclude_object]

# G-Code macro for managing multi-object prints
# Enables canceling, defining, switching, and restoring objects during a print
[gcode_macro M486]
gcode:
    {% if 'exclude_object' not in printer %}
        {action_raise_error("[exclude_object] is not enabled")} # Raise error if exclude_object module isn't loaded
    {% endif %}
    {% if 'T' in params %}
        EXCLUDE_OBJECT RESET=1 # Reset the object exclusion state
        {% for i in range(params.T | int) %}
            EXCLUDE_OBJECT_DEFINE NAME={i} # Define object names as 0, 1, 2... up to the specified count
        {% endfor %}
    {% endif %}
    {% if 'C' in params %}
        EXCLUDE_OBJECT CURRENT=1 # Cancel the currently active object
    {% endif %}
    {% if 'P' in params %}
        EXCLUDE_OBJECT NAME={params.P} # Cancel a specific object by index or name
    {% endif %}
    {% if 'S' in params %}
        {% if params.S == '-1' %}
            {% if printer.exclude_object.current_object %}
                EXCLUDE_OBJECT_END NAME={printer.exclude_object.current_object} # End the current object (used for purge lines or non-object moves)
            {% endif %}
        {% else %}
            EXCLUDE_OBJECT_START NAME={params.S} # Start a new object by name or index
        {% endif %}
    {% endif %}
    {% if 'U' in params %}
        EXCLUDE_OBJECT RESET=1 NAME={params.U} # Un-cancel an object so it can continue printing (if not already skipped)
    {% endif %}

# CREDITS: https://github.com/LeeOtts/Ender3v2-Klipper-Configs/blob/main/Line_Purge.cfg
# This macro will parse information from objects in your gcode and create a nearby purge!
# For successful purging, you may need to configure:
# 
# [extruder]
# ...
# max_extrude_cross_section: 5

[gcode_macro LINE_PURGE]
description: A purge macro that adapts to be near your actual printed objects
variable_adaptive_enable: True      # Change to False if you'd like the purge to be in the same spot every print
variable_z_height: 0.4              # Height above the bed to purge
variable_purge_amount: 20           # Amount of filament in millimeters to purge
variable_line_length: 40            # Overall desired length of purge line in millimeters, around 1/5th of X axis length is a good starting value
variable_flow_rate: 12              # Desired flow rate in mm3/s (Around 12 for standard flow hotends, around 24 for high flow hotends)
variable_x_default: 15             # Default X location to purge. If adaptive_enable is True, this is overwritten
variable_y_default: 15            # Default Y location to purge. If adaptive_enable is True, this is overwritten
variable_distance_to_object_y: 30   # Y distance in millimeters away from the print area for purging. Must be less than or equal to y_default if adaptive_enable is False
variable_display_parameters: True   # Display macro paramters in the console, useful for debugging the SETUP_LINE_PURGE call, or more verbosity.
gcode:
    {% if display_parameters == True %}
      { action_respond_info("adaptive_enable : %d" % (adaptive_enable))  }
      { action_respond_info("z_height        : %f" % (z_height))  }
      { action_respond_info("purge_amount    : %f" % (purge_amount))  }
      { action_respond_info("line_length     : %f" % (line_length))  }
      { action_respond_info("flow_rate       : %f" % (flow_rate))  }
      { action_respond_info("x_default       : %f" % (x_default))  }
      { action_respond_info("y_default       : %f" % (y_default))  }
      { action_respond_info("distance_to_object_y : %f" % (distance_to_object_y))  }
    {% endif %}

    {% if adaptive_enable == True %}
        {% set all_points = printer.exclude_object.objects | map(attribute='polygon') | sum(start=[]) %}
        {% set x_origin = (all_points | map(attribute=0) | min | default(x_default)) %}
        {% set y_origin = (all_points | map(attribute=1) | min | default(y_default)) %}
        {% set x_origin = ([x_origin, 0] | max) %}
        {% set y_origin = ([y_origin, 0] | max) %}
    {% else %}
        {% set x_origin = x_default | float %}
        {% set y_origin = y_default | float %}
    {% endif %}
    {% set nozzle_dia = printer.configfile.config.extruder.nozzle_diameter | float %}
    {% set cross_section = nozzle_dia * z_height | float %}
    {% set purge_move_speed = (cross_section * flow_rate) * 60 | float %}
    {% set travel_speed = (printer.toolhead.max_velocity) * 60 | float %}

    G92 E0                                                                              # Reset extruder
    G0 F{travel_speed}                                                                  # Set travel speed
    G90                                                                                 # Absolute positioning
    G0 X{x_origin} Y{y_origin - distance_to_object_y}                                   # Move to purge position
    G0 Z{z_height}                                                                      # Move to purge Z height
    M83                                                                                 # Relative extrusion mode
    G1 X{x_origin + line_length} E{purge_amount} F{purge_move_speed}                    # Purge line
    G1 E-.5 F2100                                                                       # Retract
    G92 E0                                                                              # Reset extruder distance
    M82                                                                                 # Absolute extrusion mode
    G0 Z{z_height * 2} F{travel_speed}                                                  # Z hop

[gcode_macro SETUP_LINE_PURGE]
gcode:
    SET_GCODE_VARIABLE MACRO=LINE_PURGE  VARIABLE=display_parameters   VALUE={params.DISPLAY_PARAMETERS|default(True)|int}
    SET_GCODE_VARIABLE MACRO=LINE_PURGE  VARIABLE=adaptive_enable   VALUE={params.ADAPTIVE_ENABLE|default(True)|int}
    SET_GCODE_VARIABLE MACRO=LINE_PURGE  VARIABLE=z_height      VALUE={params.Z_HEIGHT|default(0.4)|float}
    SET_GCODE_VARIABLE MACRO=LINE_PURGE  VARIABLE=purge_amount  VALUE={params.PURGE_AMOUNT|default(40)|float}
    SET_GCODE_VARIABLE MACRO=LINE_PURGE  VARIABLE=line_length  VALUE={params.LINE_LENGTH|default(50)|float}
    SET_GCODE_VARIABLE MACRO=LINE_PURGE  VARIABLE=flow_rate     VALUE={params.FLOW_RATE|default(12)|float}
    SET_GCODE_VARIABLE MACRO=LINE_PURGE  VARIABLE=x_default     VALUE={params.X_DEFAULT|default(10)|float}
    SET_GCODE_VARIABLE MACRO=LINE_PURGE  VARIABLE=y_default     VALUE={params.Y_DEFAULT|default(10)|float}
    SET_GCODE_VARIABLE MACRO=LINE_PURGE  VARIABLE=distance_to_object_y     VALUE={params.DISTANCE_TO_OBJECT_Y|default(10)|float}